```sql
CREATE PROCEDURE movimento() RETURNS trigger AS $$
	DECLARE
		SALDO INTEGER
	BEGIN
		SELECT CONTOCORRENTE.SALDO INTO SALDO
		FROM CONTOCORRENTE
		WHERE CONTOCORRENTE.IBAN = NEW.IBAN;
		
		IF SALDO-NEW.IMPORTO < 0 THEN
			RAISE EXCEPTION 'Errore: importo superiore al saldo';
		ELSE
			INSERT INTO MOVIMENTO
			VALUES(NEW.NUMERO, NEW.IBAN, NEW.DATA, NEW.IMPORTO);
			
			UPDATE CONTOCORRENTE
			SET CONTOCORRENTE.SALDO = CONTOCORRENTE.SALDO-NEW.IMPORT
			WHERE CONTOCORRENTE.IBAN=NEW.IBAN;
		END IF;
		RETURN NEW;
	END;
$$ LANGUAGE 'plpsql';

CREATE TRIGGER INSERIMENTO_MOVIMENTO
	BEFORE INSERT ON MOVIMENTO
	FOR EACH ROW
	EXECUTE PROCEDURE movimento();
```
